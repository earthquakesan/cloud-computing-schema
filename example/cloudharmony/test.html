<!DOCTYPE html>
<html>
    <head>
        <script async type="text/javascript" src="speedtest-googlecompute.js"></script>
        <script type="text/javascript">
        /* STEP 2
        * After the test script loads, a global variable named 'speedtest' will be 
        * present referencing an instance of the test driver.
        * The test must be started manually. To do so, the 'start' method should be 
        * invoked after the script loads. Because the script will likely be loaded
        * asynchronously, to simplify load detection, it will check for existence 
        * of a function named 'ch_st_loaded'. If this function exists, it will be 
        * called with a reference to speedtest as the first argument. The start() method 
        * may then be invoked to begin testing. The code below demonstrates how this 
        * might be implemented:
        */
        function ch_st_loaded(speedtest) {
            /*
            * CALLBACK OBJECT
            * cloudharmony-speedtest Sample Callback Object
            *
            * This Javascript object demonstrates the callback methods and corresponding 
            * API documentation for cloudharmony-speedtest. All methods in this 
            * object are optional (the speedtest checks if methods exist before invoking).
            */
            var st_callback = function() {
            
                /*
                    * This method is invoked before the speedtest starts. If it returns false 
                    * test execution will stop
                    * 
                    * @param array tests an ordered array representing the tests to be performed 
                    * and the test order. Each item in the array is an object with the following 
                    * attributes:    
                    *   concurrency: (optional) concurrency for downlink/uplink tests - this 
                    *     signifies the number of concurrent threads that will be used during
                    *     each test iteration. Test result metrics are an aggregation of metrics 
                    *     for each thread
                    *   duration: estimated test duration in seconds
                    *   iterations: total number of test iterations to be performed - including 
                    *     warmup iterations
                    *   location: (optional) location metadata for the test endpoint - an object 
                    *     with these attributes: city, state, country, lat, long. Not present 
                    *     for endpoints without location information (e.g. CDN, DNS)
                    *   max_size: (optional) maximum size (KB) for uplink/downlink tests
                    *   min_size: (optional) minimum size (KB) for uplink/downlink tests
                    *   provider_id: identifier of the provider (e.g. aws) - see
                    *     https://cloudharmony.com/docs/api#!/api/Get_Providers
                    *   region: (optional) identifier of the service region (e.g. us-east-1) - see
                    *     https://cloudharmony.com/docs/api#!/api/Get_Service
                    *   service: name of the service (e.g. Amazon EC2)
                    *   service_id: identifier of the service (e.g. aws:ec2) - see
                    *     https://cloudharmony.com/docs/api#!/api/Get_Services
                    *   service_type: service type identifier - one of: cdn, compute, dns, paas, 
                    *     storage
                    *   subregion: (optional) identifier of the provider subregion (e.g. us-east-1a)
                    *   type: test type identifier - one of: downlink, uplink, latency, dns
                    *   warmup: number of warmup iterations - these precede test iterations and
                    *     are excluded from result metrics
                    * 
                    * @param object types object with keys corresponding with every test type and 
                    * values describing associated test parameters. Value objects include the 
                    * following attributes:
                    *   duration: total estimated duration for all tests of this type in seconds
                    *   tests: total number of tests of this type
                    * @return boolean
                    */

                this.started = function(tests, types) {
                    console.log("START CALLBACK");
                    console.log(JSON.stringify(tests));
                    console.log(JSON.stringify(types));
                };
                
                /*
                    * This method is invoked when a new test begins and following each test 
                    * iteration. If it returns false, 'test' will be aborted and testing 
                    * advanced to the next test
                    * 
                    * @param object test object representing the test this progress pertains to
                    * (see started method API documentation above for object attributes)
                    * @param object progress an object describing the the test progress. This 
                    * object contains the following attributes:
                    *   bytes: total number of bytes transferred for this test
                    *   failed: current number of failed iterations. Test will be aborted if 3
                    *     iterations fail
                    *   iteration: test iteration for this progress (0 if test is starting)
                    *   iterations: total test iterations (warmup + test iterations)
                    *   progress: completion percentage for this test
                    *   remaining: number of iterations remaining (i.e. iterations - iteration)
                    *   success: number of successful iterations completed
                    *   time_remaining: estimated time remaining for this test in seconds
                    *   tests_progress: completion percentage for ALL tests
                    *   tests_remaining: number of tests remaining
                    *   tests_time_remaining: estimated time remaining for ALL tests in seconds
                    *   type_progress: completion percentage for ALL tests of this type
                    *   type_remaining: number of tests remaining of this type
                    *   type_time_remaining: estimated time remaining for ALL tests of this type 
                    *     in seconds
                    *   warmup: true if this progress is for a warmup iteration. warmup 
                    *     iteration metrics are excluded from results
                    * @return boolean
                    */
                this.progress = function(test, progress) {
                    console.log("PROGRESS CALLBACK");
                    console.log(JSON.stringify(test));
                    console.log(JSON.stringify(progress));
                };

                /*
                    * This method is invoked when test finishes. If it returns false, testing 
                    * will stop, otherwise it will advance to the next test
                    * 
                    * @param object test object representing the test these results pertains to
                    * (see started method API documentation above for object attributes)
                    * @param object results an object containing details of the test results.
                    * This object contains the attributes below (* attributes present only if 
                    * status is not 'failed'). Metrics are milliseconds (ms) for latency or dns 
                    * tests, and megabits per second (Mb/s) for uplink or downlink tests:
                    *   bytes: total bytes transferred for this test including warmup iterations
                    *   fastest*: fastest result metric
                    *   failed: number of failed iterations (including warmup)
                    *   mean*: mean result metric
                    *   median*: median result metric
                    *   metric10*: 10th percentile result metric (slowest)
                    *   metric25*: 25th percentile result metric
                    *   metric75*: 75th percentile result metric
                    *   metric90*: 90th percentile result metric (fastest)
                    *   metrics*: array containing all result metrics (warmup excluded)
                    *   sequence: test sequence number (first test sequence=1)
                    *   slowest*: slowest result metric
                    *   secure: true if HTTPS protocol used for testing
                    *   status: test status - one of: success, partial, failed
                    *   stdev*: sample standard deviation for test metrics (warmup excluded)
                    * @return boolean
                    */
                this.results = function(test, results) {
                    console.log("RESULTS CALLBACK");
                    console.log(JSON.stringify(test));
                    console.log(JSON.stringify(results));
                };
                
                return this;
            };
            var uplinkRedirectUri = "test.html"; // change this to the URI where up.html is accessible on your server
            console.log(speedtest.start(st_callback, uplinkRedirectUri));
        }
        </script>
                
    </head>

</html>