<!doctype html>

<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Demo (Using JSON-LD Macros): For Google Cloud</title>
  <meta name="author" content="Antonio Garrote">

  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/codemirror.css">
  <link rel="stylesheet" href="./css/admin.css">

  <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js'></script>
  <script type='text/javascript' src='https://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js'></script>
  <script type='text/javascript' src='./js/rdf_store_min_formated.js'></script>
  <script type='text/javascript' src='./js/bootstrap-modal.js'></script>
  <script type='text/javascript' src='./js/bootstrap-tabs.js'></script>
  <script type='text/javascript' src='./js/beautify.js'></script>
  <script type='text/javascript' src='./js/macro.js'></script>
  <script type='text/javascript' src='https://ariutta.github.io/semantic-ko/dist/semko.min.js'></script>
  <script type='text/javascript' src='./js/codemirror.js'></script>
  <script type='text/javascript' src='./js/bootstrap-tabs.js'></script>
  <script type='text/javascript' src='./js/modes/javascript.js'></script>
  <script type='text/javascript' src='./js/modes/css.js'></script>
  <script type='text/javascript' src='./js/modes/xml.js'></script>
  <script type='text/javascript' src='./js/modes/htmlmixed.js'></script>
  <script type='text/javascript'>
    jQuery(document).ready(function(){
      //var url = "https://cloudbilling.googleapis.com/v1/services?key=";
      var url = "https://cloudbilling.googleapis.com/v1/services/6F81-5844-456A/skus?key=";
      var url_pattern = "https://cloudbilling.googleapis.com/v1/services/6F81-5844-456A/skus*";
      const JS_HEAP_SIZE_LIMIT = performance.memory.jsHeapSizeLimit; // will give you the JS heap size

      rdfstore.create(function(store) {
        sko.ready(store, function(){  

          var viewModel = {
            gcloudAPIkey: ko.observable("AIzaSyAatoGd0fqx0t2Y_iC605EtHXqTsWW7kHQ"),
            originalEditor: ko.observable(),
            transformationEditor: ko.observable(),
            transformedEditor: ko.observable(),
            defaultQuery: ko.observable(
              `PREFIX cocoon: <https://w3id.org/cocoon/def#>\n`
              +`PREFIX schema:<http://schema.org/>\n`
              + `SELECT * { ?s ?p ?o }`
            ),
            bindingVariables: ko.observable([]),
            bindings: ko.observable([]),
            crumbs: ko.observable([]),
            selectedCrumb: ko.observable('step-load'),
            jsHeapSizeLimit: ko.observable(Math.floor(JS_HEAP_SIZE_LIMIT/(1024*1024))),
            alert: ko.observable(""),
            displayLimit:ko.observable(1200)
          };

          viewModel.showCrumb = function(step) {
            var newCrumbs = [];
            for(var i=0; i<viewModel.crumbs(); i++) {
              if(viewModel.crumbs()[i] === step)
                break;
            }
            if(step === 'step-load') {
              viewModel.crumbs([]);
              viewModel.selectedCrumb('step-load');
            } else if(step === 'step-transform') {
              viewModel.crumbs(['step-load']);
              viewModel.selectedCrumb('step-transform');
            } else if(step === 'step-import') {
              viewModel.crumbs(['step-load', 'step-transform']);
              viewModel.selectedCrumb('step-import');
            } else if(step === 'step-query') {
              viewModel.crumbs(['step-load', 'step-transform', 'step-import']);
              viewModel.selectedCrumb('step-query');
            }
          };

          viewModel.textForCrumb = function(step) {
            if(step === 'step-load') {
              return "1. Load remote data";
            } else if(step === 'step-transform') {
              return "2. Define a transformation";
            } else if(step === 'step-import') {
              return "3. Import the transformed data";
            } else if(step === 'step-query') {
              return "4. Query the imported data";
            }
          };

          viewModel.textForSelectedCrumb = ko.dependentObservable(
            function(){
              return viewModel.textForCrumb(viewModel.selectedCrumb());
            }
            );

          function step_transform(data) {
            viewModel.crumbs(['step-load']);
            viewModel.selectedCrumb('step-transform');

            data = js_beautify(JSON.stringify(data))
            var editor = viewModel.originalEditor();
            if(editor == null) {
              editor = CodeMirror(document.getElementById("loaded"), 
              {
                smartIndent: true,
                lineNumbers: true,
                lineWrapping: false,
                electricChars: true,
                readOnly: true,
                value: data,
                mode:  {name: "javascript", json: true}
              });
              viewModel.originalEditor(editor);
            } else {
              editor.setValue(data)
            }


            editor = viewModel.transformationEditor();
            if(editor == null) {
              editor = CodeMirror(document.getElementById("transformation"), 
              {
                smartIndent: true,
                lineNumbers: true,
                lineWrapping: false,
                electricChars: true,
                readOnly: false,
                value: js_beautify(viewModel.transformation()),
                mode:  {name: "javascript", json: true}
              });
              viewModel.transformationEditor(editor);        
            }
          };

          viewModel.loadGcloudAPI = function()  {              
            viewModel.crumbs([]);
            viewModel.selectedCrumb('step-load');

            let uri = url+this.gcloudAPIkey();
            $.ajax({
              url: uri,
              type: 'GET',
              contentType: "application/json",
              dataType: "json",
              success : function(text) {
                step_transform(text);
              },
              error : function (xhr, ajaxOptions, thrownError){  
                console.log(xhr.status);          
                console.log(thrownError);
              } 
            });

          };

          viewModel.applyTransformation = function() {
            viewModel.crumbs(['step-load', 'step-transform']);
            viewModel.selectedCrumb('step-import');

            var originalData = viewModel.originalEditor().getValue();
            var transformationData = viewModel.transformationEditor().getValue();

            originalData = JSON.parse(originalData);
            transformationData = JSON.parse(transformationData);
            macro = jsonld_macros;
            macro.clearAPIs();
            macro.registerAPI(transformationData);

            var transformed = macro.resolve(url_pattern,
              originalData);

            var data = new Blob([js_beautify(JSON.stringify(transformed))]);
		        var download = document.getElementById("download_transformed_data");
            download.href = URL.createObjectURL(data);

            var editor = viewModel.transformedEditor();
            if(editor == null) {
              editor = CodeMirror(document.getElementById("transformed"), 
              {
                smartIndent: true,
                lineNumbers: true,
                lineWrapping: false,
                electricChars: true,
                readOnly: false,
                value: js_beautify(JSON.stringify(transformed)),
                mode:  {name: "javascript", json: true}
              });     

              viewModel.transformedEditor(editor);
            } else {
              editor.setValue(js_beautify(JSON.stringify(transformed)))
            }
          };

          viewModel.loadStore = function() {
            var transformed = JSON.parse(viewModel.transformedEditor().getValue());
           sko.store.clear(function() {});
            
            sko.store.load("application/json", transformed, function(success, results){
              
              if(success) {
                sko.store.execute(viewModel.defaultQuery(), function(success, results) {
                 
                  if(success) {
                    var variables = [];
                    for(var p in (results[0]||{})) {
                      variables.push(p);
                    }
                    var bindings = [];
                    var row;
                    let i;
                    for(i=0; i<results.length && i<viewModel.displayLimit() ; i++) {
                      row = [];
                      for(var p=0; p<variables.length;  p++){
                        row.push(results[i][variables[p]].value);
                      }
                      bindings.push(row);
                    }
                    if(i == viewModel.displayLimit()){
                      let msg = 
                        `Display Limit ( ${viewModel.displayLimit()} ) Reached!\n`
                        + `Number of Results truncated (not displayed): ${results.length - viewModel.displayLimit()}`
                      ;
                      viewModel.alert(
                        `<div class="alert-message">
                            <strong >${msg}</strong>
                        </div>`                       
                      );
                    }

                    viewModel.bindingVariables(variables);
                    viewModel.bindings(bindings);
                    viewModel.crumbs(['step-load', 'step-transform', 'step-import']);
                    viewModel.selectedCrumb('step-query');

                  } else {
                    alert("Query failed: "+results);
                  }
                });
              } else {
                alert("Error loading transformed data");
              }
            });
          };

          viewModel.runQuery = function() {
            sko.store.execute(viewModel.defaultQuery(), function(success, results) {
              if(success) {
                var variables = [];
                for(var p in (results[0]||{})) {
                  variables.push(p);
                }
                var bindings = [];
                var row;
                for(var i=0; i<results.length && i<viewModel.displayLimit(); i++) {
                  row = [];
                  // debugger;
                  for(var p=0; p<variables.length;  p++){
                    row.push(results[i][variables[p]].value);
                  }
                  bindings.push(row);
                }

                viewModel.bindingVariables(variables);
                viewModel.bindings(bindings);
              } else {
                alert("Query failed: "+results);
              }
            });

          };

          viewModel.transformation = ko.observable(
            `
{
  "`+url_pattern+`": {
    "$":{
      "@context":{
        "schema":"http://schema.org",
        "cocoon":"https://w3id.org/cocoon/def",
        "gr": "http://purl.org/goodrelations/v1#",
        "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
        "skus": "cocoon:CloudResource",
        "skuId":"cocoon:Key",
        "name":"cocoon:Name",
        "description":"schema:description",
        "usageType":"cocoon:UsageType"
      }
    },
    "$.skus[*]":{
      "@remove": "pricingInfo"
    }
  }
}
            `
            );

          sko.applyBindings("body", viewModel, function(){});
        });
      });
    
    });

  </script>
</head>

<body>
  <!-- Breadcrumb -->
  <ul class='breadcrumb' data-bind='template: "breadcrumb-template"'></ul>

  <!-- holder for the frontend -->
  <div class='container'>

    <section id='step-load' data-bind='visible: selectedCrumb()==="step-load"'>
      <div class='page-header'>
        <h1>1. Load data from 
          <a target='_blank' href='https://cloud.google.com/billing/v1/how-tos/catalog-api'>
            Google Cloud's API
          </a>
        </h1>
      </div>
      <div class='row'>
        <div class='span8'>
          <form>
            <fieldset>
              <label for="github-user"><b>Google Cloud API key:</b></label> 
              <div class="input">
                <input id="github-user" class="xlarge" type="text" size="30" name="xlInput" data-bind='value: gcloudAPIkey'></input>
              </div>
            </fieldset>
          </form>
        </div>
        <div class='span2'>
          <fieldset>
            <div class="input" data-bind='click: loadGcloudAPI'>
              <button class='btn primary'>load</button>
            </div>
          </fieldset>
        </div>
      </div>
    </section>

    <section id='step-transform' data-bind='visible: selectedCrumb()==="step-transform"'>
      <div class='page-header'>
        <h1>2. Transform the data applying a JSON-LD transformation</h1>
      </div>
      <div class='row'>
        <div class='span8'>
          <div class='row ex-editor-ttitle'>
            <h3 class='span8'>Loaded data</h3>
          </div>
          <div id='loaded'>
          </div>
        </div>

        <div class='span8'>
          <div class='row ex-editor-ttitle'>
            <h3 class='span8'>Transformation</h3>
          </div>
          <div id='transformation'>
          </div>
        </div>
      </div>

      <div class='row'>
        <div class='span16'>
          <fieldset>
            <div class='actions'>
              <div class="input" data-bind='click: applyTransformation'>
                <button class='btn primary'>Transform</button>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </section>


    <section id='step-import' data-bind='visible: selectedCrumb()==="step-import"'>
      <div class='page-header'>
        <h1>3. Import the transformed data into a RDF store</h1>
      </div>
      <div class='row'>
        <div class='span16'>
          <div class='row ex-editor-ttitle'>
            <h3 class='span8'>Transformed data</h3>
          </div>
          <div id='transformed'>
          </div>
        </div>
      </div>
      <div class='row'>
        <div class='span16'>
          <fieldset>
            <div class='actions'>
              <div class="input" >
                <button class='btn primary' data-bind='click: loadStore' >Load Transformed Data To RDF store</button>
                <a id="download_transformed_data" download="download.jsonld" type="text/jsonld" target="_blank">Download Transformed Data</a>
              </div>
              <p>JavaScript heap size limit:
                <span data-bind='text: jsHeapSizeLimit'>&nbsp;</span> MB
              </p>
              <p>Currently there is a performace bottleneck causing:
                "Maximum call stack size exceeded" error.<br/>
                So this demo limits the number of items can be displayed to:<br/>
                <input data-bind='value: displayLimit'/><br/>
                Additional records are simply discarded.<br/>
                You can tweak this value, but results are not guaranteed to display.<br/>
              </p>
            </div>
          </fieldset>
        </div>
      </div>
    </section>

    <section id='step-query' data-bind='visible: selectedCrumb()==="step-query"'>
      <div class='page-header'>
        <h1>4. Query the data using SPARQL</h1>
      </div>
      <div id="alert" data-bind="html: alert"></div>
      <div class='row'>
        <div class='row'>
          <div class='span16'>
            <div class='row ex-editor-ttitle'>
              <h3 class='span8'>Loaded Query Data</h3>
            </div>
            <div id='transformed'>
            </div>
          </div>
        </div>

        <span class='span16' data-bind="template:'sparql-results-template'" style='height: 500px; overflow:scroll'></span>

        <div class='row'>
          <div class='span16'>
            <form>
              <fieldset>
                <div class='clearfix'>
                  <label for='sparql-query-text'>
                    <b>SPARQL query</b>
                  </label>
                  <div class='input'>
                    <textarea id="sparql-results-text" class="xxlarge" rows="3" data-bind='value:defaultQuery'></textarea>
                  </div>
                </div>
              </fieldset>
            </form>
          </div>
        </div>

        <div class='row'>
          <div class='span16'>
            <form>
              <fieldset>
                <div class='actions'>
                  <div class="input" data-bind='click: runQuery'>
                    <button class='btn primary'>Run Query</button>
                  </div>
                </div>
              </fieldset>
            </form>
          </div>
        </div>
      </div>
    </section>


    <!-- end of container -->    
  </div>
  <script id='breadcrumb-template' type='text/html'>
    {{each crumbs}}
    <li><a href='#' data-bind='click: function(){ showCrumb($value); }, text: textForCrumb($value)'>${$value}</a><span class="divider"> > </span></li>
    {{/each}}

    <li class='active' data-bind='text: textForSelectedCrumb'></li>
  </script>

  <script id='sparql-results-template' type='text/html'>
    <div id='sparql-results-table-rows'>
      <table>
        <thead>
          <tr>
            {{each bindingVariables}}
            <th scope='col'>${$value}</th>
            {{/each}}
          </tr>
        </thead>
        <tbody>
          {{each bindings}}
          <tr>
            {{each $value}}
            <td>${$value}</td>
            {{/each}}
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </script>

</body>

</html>
